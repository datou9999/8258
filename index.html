<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>åœ¨çº¿å®¢æœ - æ¥ç”µç¤ºèŒƒ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      margin: 0;
      padding: 20px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* æ‹¨å·ç›˜ç›¸å…³ */
    #dialpadUI {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #numberDisplay {
      font-size: 2rem;
      text-align: center;
      width: 250px;
      height: 50px;
      line-height: 50px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      user-select: none;
      margin-bottom: 15px;
    }
    #keypad {
      width: 270px;
      display: grid;
      grid-template-columns: repeat(3, 80px);
      grid-gap: 12px;
      margin-bottom: 15px;
    }
    .key {
      background: white;
      border-radius: 50%;
      height: 80px;
      font-size: 1.8rem;
      color: #333;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
      transition: background-color 0.2s;
    }
    .key:active {
      background: #d0d0d0;
    }
    #callButton {
      width: 250px;
      padding: 15px 0;
      background-color: #007bff;
      color: white;
      font-size: 1.6rem;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,123,255,0.6);
      user-select: none;
      margin-bottom: 10px;
      transition: background-color 0.3s;
    }
    #callButton:disabled {
      background-color: #a5c8ff;
      cursor: not-allowed;
      box-shadow: none;
    }

    /* æ¥ç”µç•Œé¢ */
    #incomingUI {
      display: none;
      flex-direction: column;
      align-items: center;
      background: #fff;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      width: 280px;
    }
    #incomingUI h2 {
      margin: 0 0 15px 0;
      font-size: 1.8rem;
      color: #333;
    }
    #incomingNumber {
      font-size: 2rem;
      margin-bottom: 15px;
      user-select: none;
    }
    #hangupButton {
      width: 250px;
      padding: 15px 0;
      background-color: #dc3545;
      color: white;
      font-size: 1.6rem;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(220,53,69,0.6);
      user-select: none;
      transition: background-color 0.3s;
    }
    #hangupButton:disabled {
      background-color: #f5aeb0;
      cursor: not-allowed;
      box-shadow: none;
    }

    #callStatus {
      margin-top: 15px;
      font-size: 1.4rem;
      color: #555;
      user-select: none;
      min-height: 30px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>åœ¨çº¿å®¢æœ</h1>

  <!-- æ‹¨å·ç•Œé¢ -->
  <div id="dialpadUI">
    <div id="numberDisplay"></div>
    <div id="keypad">
      <div class="key">1</div>
      <div class="key">2</div>
      <div class="key">3</div>
      <div class="key">4</div>
      <div class="key">5</div>
      <div class="key">6</div>
      <div class="key">7</div>
      <div class="key">8</div>
      <div class="key">9</div>
      <div class="key">*</div>
      <div class="key">0</div>
      <div class="key">#</div>
    </div>
    <button id="callButton" disabled>ğŸ“ æ‹¨å·</button>
  </div>

  <!-- æ¥ç”µç•Œé¢ -->
  <div id="incomingUI">
    <h2>æ¥ç”µä¸­</h2>
    <div id="incomingNumber">æœªçŸ¥å·ç </div>
    <button id="hangupButton" disabled>ğŸ›‘ æŒ‚æ–­</button>
  </div>

  <div id="callStatus">æœªå‘¼å«</div>

  <audio id="audioRemote" autoplay></audio>

  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jssip@3.0.10/dist/jssip.min.js"></script>

  <script>
    // ç¦æ­¢å³é”®èœå•å’Œ F12
    document.addEventListener('contextmenu', e => {
      e.preventDefault();
      alert('å³é”®åŠŸèƒ½å·²ç¦ç”¨');
    });
    document.onkeydown = function (e) {
      if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'i') || (e.ctrlKey && e.key.toLowerCase() === 'u')) {
        alert('å¼€å‘è€…å·¥å…·å·²ç¦ç”¨');
        return false;
      }
    };

    const numberDisplay = document.getElementById('numberDisplay');
    const callBtn = document.getElementById('callButton');
    const hangupBtn = document.getElementById('hangupButton');
    const callStatus = document.getElementById('callStatus');
    const incomingUI = document.getElementById('incomingUI');
    const incomingNumber = document.getElementById('incomingNumber');
    const dialpadUI = document.getElementById('dialpadUI');
    const remoteAudio = document.getElementById('audioRemote');

    let dialedNumber = '';
    let session = null;
    let isCalling = false;

    // SIP é…ç½®ï¼Œæ¢æˆä½ è‡ªå·±çš„
    const socket = new JsSIP.WebSocketInterface('wss://123.xin.anjre.cn:8089/ws');
    const configuration = {
      sockets: [socket],
      uri: 'sip:1001@123.xin.anjre.cn',
      password: 'Aa6363463@',
      display_name: 'ç½‘é¡µå®¢æˆ·',
      session_timers: false,
      register: true
    };
    const ua = new JsSIP.UA(configuration);
    ua.start();

    ua.on('registered', () => console.log('âœ… æ³¨å†ŒæˆåŠŸ'));
    ua.on('registrationFailed', e => console.error('âŒ æ³¨å†Œå¤±è´¥', e));
    ua.on('disconnected', () => console.warn('SIP WebSocket æ–­å¼€'));

    // æ•°å­—æŒ‰é”®äº‹ä»¶
    document.querySelectorAll('.key').forEach(key => {
      key.addEventListener('click', () => {
        if(isCalling) return; // é€šè¯ä¸­ä¸èƒ½è¾“å…¥
        dialedNumber += key.textContent;
        numberDisplay.textContent = dialedNumber;
        callBtn.disabled = dialedNumber.length === 0;
        callStatus.textContent = dialedNumber.length > 0 ? 'å‡†å¤‡æ‹¨å·' : 'æœªå‘¼å«';
      });
    });

    // æ‹¨å·æŒ‰é’®ç‚¹å‡»
    callBtn.addEventListener('click', async () => {
      if (isCalling) return;
      if (dialedNumber.length === 0) return;

      try {
        callStatus.textContent = 'è¯·æ±‚éº¦å…‹é£æƒé™...';
        await navigator.mediaDevices.getUserMedia({ audio: true });
        callStatus.textContent = 'æ‹¨å·ä¸­...';
      } catch(err) {
        alert('è¯·å…è®¸ä½¿ç”¨éº¦å…‹é£');
        callStatus.textContent = 'éº¦å…‹é£æƒé™è¢«æ‹’ç»';
        return;
      }

      isCalling = true;
      callBtn.disabled = true;
      hangupBtn.disabled = false;

      session = ua.call(`sip:${dialedNumber}@123.xin.anjre.cn`, {
        mediaConstraints: { audio: true, video: false },
        rtcOfferConstraints: { offerToReceiveAudio: 1, offerToReceiveVideo: 0 }
      });
    });

    // æŒ‚æ–­æŒ‰é’®
    hangupBtn.addEventListener('click', () => {
      if(session) session.terminate();
    });

    function resetUI() {
      isCalling = false;
      dialedNumber = '';
      numberDisplay.textContent = '';
      callBtn.disabled = true;
      hangupBtn.disabled = true;
      callStatus.textContent = 'æœªå‘¼å«';
      session = null;

      // æ¢å¤æ‹¨å·ç›˜ç•Œé¢ï¼Œéšè—æ¥ç”µç•Œé¢
      dialpadUI.style.display = 'flex';
      incomingUI.style.display = 'none';
    }

    // ç›‘å¬æ–°ä¼šè¯ï¼ˆå«æ¥ç”µï¼‰
    ua.on('newRTCSession', e => {
      session = e.session;

      if(session.direction === 'incoming') {
        // æ¥ç”µå¤„ç†
        const caller = session.remote_identity.uri.user || 'æœªçŸ¥å·ç ';
        incomingNumber.textContent = caller;
        callStatus.textContent = 'æ¥ç”µä¸­...';

        // åˆ‡æ¢UIï¼Œéšè—æ‹¨å·ç›˜ï¼Œæ˜¾ç¤ºæ¥ç”µç•Œé¢
        dialpadUI.style.display = 'none';
        incomingUI.style.display = 'flex';

        hangupBtn.disabled = false;
        callBtn.disabled = true;

        // è‡ªåŠ¨æ¥å¬
        session.answer({ mediaConstraints: { audio: true, video: false } });
        callStatus.textContent = 'é€šè¯ä¸­';

        session.connection.addEventListener('addstream', evt => {
          if(evt.stream) {
            remoteAudio.srcObject = evt.stream;
            remoteAudio.play().catch(console.warn);
          }
        });

        session.on('ended', () => {
          callStatus.textContent = 'é€šè¯ç»“æŸ';
          resetUI();
        });

        session.on('failed', () => {
          callStatus.textContent = 'é€šè¯å¤±è´¥';
          resetUI();
        });

      } else {
        // ä¸»åŠ¨å‘¼å‡ºå¤„ç†
        callStatus.textContent = 'æ‹¨å·ä¸­...';

        session.connection.addEventListener('addstream', evt => {
          if(evt.stream) {
            remoteAudio.srcObject = evt.stream;
            remoteAudio.play().catch(console.warn);
          }
        });

        session.on('progress', () => callStatus.textContent = 'æŒ¯é“ƒä¸­...');
        session.on('accepted', () => callStatus.textContent = 'é€šè¯ä¸­');
        session.on('ended', () => {
          callStatus.textContent = 'é€šè¯ç»“æŸ';
          resetUI();
        });
        session.on('failed', () => {
          callStatus.textContent = 'é€šè¯å¤±è´¥';
          resetUI();
        });

        hangupBtn.disabled = false;
        callBtn.disabled = true;

        // æ¥ç”µç•Œé¢éšè—ï¼Œæ˜¾ç¤ºæ‹¨å·ç›˜
        dialpadUI.style.display = 'flex';
        incomingUI.style.display = 'none';
      }
    });

    // é¡µé¢éšè—æé†’ï¼ˆå¯é€‰ï¼‰
    document.addEventListener('visibilitychange', () => {
      if(document.hidden) alert('è¯·ä¿æŒé¡µé¢å‰å°ä»¥ç¡®ä¿é€šè¯é¡ºç•…');
    });

    // WebSocketçŠ¶æ€æ—¥å¿—
    socket.onopen = () => console.log('âœ… WebSocket å·²è¿æ¥');
    socket.onerror = err => console.error('âŒ WebSocket è¿æ¥å¤±è´¥:', err);
    socket.onclose = () => console.warn('WebSocket å·²å…³é—­');

  </script>
</body>
</html>
